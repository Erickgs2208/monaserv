<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Scalability and load-balancing &#8212; MonaServer</title>
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" type="text/css" href="_static/my-styles.css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />

  
  <link href='http://fonts.googleapis.com/css?family=Lobster' rel='stylesheet' type='text/css'>
  <link href='http://fonts.googleapis.com/css?family=Cabin' rel='stylesheet' type='text/css'>
  
  
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-X2W458X7ZT"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
  
    gtag('config', 'G-X2W458X7ZT');
  </script>

  
  <a href="https://github.com/MonaSolutions/MonaServer2"
     class="visible-desktop hidden-xs"><img
    id="gh-banner"
    style="position: absolute; top: 50px; right: 0; border: 0;"
    src="_static/githubBlack.png"
    alt="Fork us on GitHub"></a>
  <script>
    // Adjust image position with banner height
    $(function () {
      var navHeight = $(".navbar .container").css("height");
      $("#gh-banner").css("top", navHeight);
    });
  </script>
  
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">


  </head><body>
    <div id="content">
    

  <div id="navbar" class="navbar navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          MonaServer</a>
        <span class="navbar-text navbar-version pull-left"><b>1</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
                <li><a href="quickstart.html"><img src="_static/star-bookmark-icone-8571-48.png"/> Quick Start</a></li>
                <li><a href="faq.html"><img src="_static/aide-point-interrogation-systeme-icone-8289-48.png"/> FAQ</a></li>
                <li><a href="contacts.html"><img src="_static/casque-ecoute-soutien-icone-9816-48.png"/> Services</a></li>
                <li><a href="roadmap.html"><img src="_static/time-system-preferences-icone-8704-48.png"/> Roadmap</a></li>
                <li><a href="manual.html"><img src="_static/texinfo-texte-x-icone-4685-48.png"/> Documentation</a></li>
            
            


            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
    
    
    

    <div class="col-md-12 content">
      
  <div class="section" id="scalability-and-load-balancing">
<h1><a class="toc-backref" href="#id1">Scalability and load-balancing</a><a class="headerlink" href="#scalability-and-load-balancing" title="Permalink to this headline">¶</a></h1>
<p>RTMFP (Real Time Media Flow Protocol) uses a server end-point to negotiate the P2P connection between clients. All media is sent directly between clients without routing it through the server, which provides extremely cost effective scalable deployments. While the media is transmitted between the clients, one server instance can only negotiate a maximum number of clients before the load becomes too heavy due to CPU/Memory limitations.</p>
<p>To resolve this issue, a full framework is included in MonaServer to enable communicatication between multiple MonaServer instances. The framework detects server connections and disconnections, manages exchanges of data between servers, manages load-balacing by redirecting clients, and has features to synchronise client information for the rendez-vous service and NetGroup RTMFP options. All communication between servers is done in a raw TCP way.</p>
<p>The main idea is simple: by default, <strong>each instance is an independent server and shares nothing with others, YOU decide what are the resources to be shared</strong> between all the server instances.</p>
<p>This page intends to describe every features of this framework illustrated with some code samples and context usage. Of course, the <a class="reference internal" href="api.html"><span class="doc">API</span></a> page lists all these feature but without code samples or any utilization context.</p>
<p>Finally some piece of script code illustrates how to use it, to know how to create an application server see <a class="reference internal" href="serverapp.html"><span class="doc">Server Application</span></a> page.</p>
<div class="contents topic" id="table-of-contents">
<p class="topic-title first">Table of Contents</p>
<ul class="simple">
<li><a class="reference internal" href="#scalability-and-load-balancing" id="id1">Scalability and load-balancing</a><ul>
<li><a class="reference internal" href="#configuration" id="id2">Configuration</a></li>
<li><a class="reference internal" href="#exchange-data-and-resources" id="id3">Exchange data and resources</a></li>
<li><a class="reference internal" href="#load-balancing-and-rendezvous-service" id="id4">Load balancing and rendezvous service</a></li>
</ul>
</li>
</ul>
</div>
<div class="section" id="configuration">
<h2><a class="toc-backref" href="#id2">Configuration</a><a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h2>
<p>Firstly to make communicate many instances of MonaServer, you have to configure them. The three following parameters permits the multiple servers mode:</p>
<ul class="simple">
<li><em>host</em> to configurate the public address of the server which will be used in client redirections.</li>
<li><em>servers.port</em> to configure the port to receive incoming server connections.</li>
<li><em>servers.targets</em> to configure the addresses of remote MonaServer instances trying to join.</li>
</ul>
<p>Here follows an illustration of one configuration with two servers:</p>
<a class="reference internal image-reference" href="_images/TwoServersScalability.png"><img alt="_images/TwoServersScalability.png" class="align-center" src="_images/TwoServersScalability.png" style="width: 733px; height: 427px;" /></a>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Exchange between servers is done in a uncrypted TCP way, so to avoid an attack by the incoming port of B, its <em>servers.port</em> configured should be protected by a firewall to allow just a connection by an other server and nothing else.</p>
</div>
<p>Following scripts should be included in root <em>main.lua</em> file to be loaded at start.</p>
<p><strong>A</strong> initializes here the connection to <strong>B</strong> (<em>server.targets</em> configured). <strong>A</strong> sees <strong>B</strong> as a target:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="c1">-- Server application on A side</span>
<span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">isTarget</span> <span class="k">then</span>
    <span class="n">NOTE</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Target gotten : &quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s"> (&quot;</span><span class="p">,</span> <span class="n">server</span><span class="p">.</span><span class="n">host</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s"> for clients)&quot;</span><span class="p">)</span>
    <span class="c1">-- displays &quot;Target gotten : 192.168.0.2 (www.hostB.com for clients)&quot;</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p><strong>B</strong>, who has an incoming port configured (1936), accepts the connection of <strong>A</strong>. <strong>B</strong> sees <strong>A</strong> as an initiator:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="c1">-- Server application on B side</span>
<span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="n">NOTE</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">isTarget</span><span class="p">)</span> <span class="c1">-- displays &quot;false&quot;</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">If server A and B configures each other as its target, the two TCP connections will be created, causing confusion in server exchange:</p>
</div>
<a class="reference internal image-reference" href="_images/DoubleConnection.png"><img alt="_images/DoubleConnection.png" class="align-center" src="_images/DoubleConnection.png" style="width: 561px; height: 273px;" /></a>
<p>This configuration system allows to scale an existing system horizontaly without having to restart server already running. Indeed, the first server started can configure its incoming server port (<em>servers.port</em>) and no target, and a new server can come to extend the system in putting the address of the first server in its <em>servers.targets</em> configuration.</p>
<p>Of course, complex configurations are possible, with multiple servers (and properties individual by server, see <a class="reference internal" href="installation.html#ref-configurations"><span class="std std-ref">Configurations</span></a>):</p>
<div class="highlight-ini notranslate"><div class="highlight"><pre><span class="c1">;MonaServer.ini</span>
<span class="na">host</span> <span class="o">=</span> <span class="s">www.myhost.com:1935</span>
<span class="k">[servers]</span>
<span class="na">targets</span> <span class="o">=</span> <span class="s">192.168.0.2:1936?type=master;192.168.0.3:1936</span>
</pre></div>
</div>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">type</span><span class="o">==</span><span class="s2">&quot;</span><span class="s">master&quot;</span> <span class="k">then</span> <span class="c1">-- true here just for 192.168.0.2:1936 server</span>
    <span class="n">NOTE</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Master server connected&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="k">function</span> <span class="nf">onServerDisconnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">type</span><span class="o">==</span><span class="s2">&quot;</span><span class="s">master&quot;</span> <span class="k">then</span> <span class="c1">-- true here just for 192.168.0.2:1936 server</span>
    <span class="n">NOTE</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Master server disconnected&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">The server applications which have the same path (<em>www/myGame</em> on server A and on server B) are synchronized but reloaded always just on connection client. It means that if you edit the file <em>www/myGame/main.lua</em> on the server A, it rebuilds the server A version on new connection client, and tries to rebuild the server B version too (of course reloading is effective just if the server B version has changed too). But if you edit the server B version and that clients are always connected by the server A intermediate, you have to edit the server A version too to get a refresh of the server B application on connection client.</p>
</div>
<p>It is also possible to reject a server adding an error in the <em>onServerConnection</em> function :</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="c1">-- Reject all connections not comming from localhost</span>
  <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">address</span> <span class="n">is</span> <span class="ow">not</span> <span class="s2">&quot;</span><span class="s">127.0.0.1&quot;</span> <span class="k">then</span>
    <span class="nb">error</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s"> is trying to connect to the server =&gt; rejected&quot;</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
<div class="section" id="exchange-data-and-resources">
<h2><a class="toc-backref" href="#id3">Exchange data and resources</a><a class="headerlink" href="#exchange-data-and-resources" title="Permalink to this headline">¶</a></h2>
<p>To exchange data between servers you have to call the <em>server:send</em> method on sender side (see <a class="reference internal" href="api.html#ref-server"><span class="std std-ref">Server</span></a> object description) and you have to define RPC server functions as a member of server object on the receiver side:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="c1">-- RPC function declaration, to receive data from one other server</span>
  <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">onHello</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="n">self</span><span class="p">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">name</span>
  <span class="k">end</span>
  <span class="c1">-- send my name to the incoming server (it will receive it on its &quot;onHello&quot; method)</span>
  <span class="n">server</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onHello&quot;</span><span class="p">,</span><span class="s2">&quot;</span><span class="s">MonaServer A&quot;</span><span class="p">)</span>
<span class="k">end</span>

<span class="c1">-- now you can find the name of each server everywhere</span>
<span class="k">for</span> <span class="n">index</span><span class="p">,</span><span class="n">server</span> <span class="k">in</span> <span class="n">mona</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span><span class="nb">ipairs</span><span class="p">()</span> <span class="k">do</span>
  <span class="n">NOTE</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Server &#39;&quot;</span><span class="o">..</span><span class="n">server</span><span class="p">.</span><span class="n">name</span><span class="o">..</span><span class="s2">&quot;</span><span class="s">&#39; at address &quot;</span><span class="o">..</span><span class="n">server</span><span class="p">.</span><span class="n">address</span><span class="p">)</span>
<span class="k">end</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last"><em>self.name = name</em> in the function body of <em>onHello</em> creates on the <em>server</em> object a <em>name</em> value. Beware with this kind of thing on <em>server</em> object, it’s shared with all other <a class="reference internal" href="serverapp.html"><span class="doc">Server Application</span></a>. If one other server application attachs too a <em>name</em> value to this <em>server</em> object, it will overload the previous assignment. A solution can be to prefix the property by the name of the current application.</p>
</div>
<p>The main goal of this exchange mechanism is to share resource wanted between all the server instances.
For example, if you use Mona to stream (by server bypass configuration, no P2P) to many subscribers, usually there are a small number of publishers and a very important number of subscribers. The server can support the publisher load, but could be saturated by the important number of listeners.
One solution in this model case is to scale horizontaly the system to share the subscribers load.</p>
<a class="reference internal image-reference" href="_images/ThreeServersExchange.png"><img alt="_images/ThreeServersExchange.png" class="align-center" src="_images/ThreeServersExchange.png" style="width: 785px; height: 461px;" /></a>
<p>Here we have a configuration with three servers, but many others could be added dynamically. The load-balacing system can be managed by a DNS way, but we have to share the publications between all three (or more) servers, otherwise one subscriber could not find one publication. Below following a complete <a class="reference internal" href="serverapp.html"><span class="doc">Server Application</span></a> to share publications between all the servers.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="c1">-- following server (horizontal scaling)</span>
<span class="n">_nextServer</span> <span class="o">=</span> <span class="kc">nil</span>

<span class="c1">-- number of subscribers (listeners) for this server</span>
<span class="n">_subscribers</span> <span class="o">=</span> <span class="mi">0</span>

<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">,</span><span class="o">...</span><span class="p">)</span>
  <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Connection of a new client on &quot;</span><span class="p">,</span> <span class="n">mona</span><span class="p">.</span><span class="n">configs</span><span class="p">[</span><span class="s2">&quot;</span><span class="s">host&quot;</span><span class="p">])</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onPublish</span><span class="p">(</span><span class="n">publication</span><span class="p">)</span>
    <span class="c1">-- informs the following server about this publication</span>
    <span class="k">if</span> <span class="n">_nextServer</span> <span class="k">then</span> <span class="n">_nextServer</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">publish&quot;</span><span class="p">,</span> <span class="n">publication</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">end</span>

    <span class="k">function</span> <span class="nf">publication</span><span class="p">:</span><span class="n">onVideo</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_nextServer</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
      <span class="c1">-- forward the video packet to the following server</span>
      <span class="n">_nextServer</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">video&quot;</span><span class="p">,</span> <span class="n">publication</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">publication</span><span class="p">:</span><span class="n">onAudio</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_nextServer</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
      <span class="c1">-- forward the audio packet to the following server</span>
      <span class="n">_nextServer</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">audio&quot;</span><span class="p">,</span> <span class="n">publication</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">publication</span><span class="p">:</span><span class="n">onData</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">onData : &quot;</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s"> - &quot;</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="k">if</span> <span class="ow">not</span> <span class="n">_nextServer</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
      <span class="c1">-- forward the data packet to the following server</span>
      <span class="n">_nextServer</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">data&quot;</span><span class="p">,</span> <span class="n">publication</span><span class="p">.</span><span class="n">name</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onUnpublish</span><span class="p">(</span><span class="n">publication</span><span class="p">)</span>
    <span class="c1">-- informs the following server about this unpublication</span>
    <span class="k">if</span> <span class="n">_nextServer</span> <span class="k">then</span> <span class="n">_nextServer</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">unpublish&quot;</span><span class="p">,</span><span class="n">publication</span><span class="p">.</span><span class="n">name</span><span class="p">)</span> <span class="k">end</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onSubscribe</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>
    <span class="c1">-- if a following server exist, and if this server has more than 400 subscribers</span>
    <span class="c1">-- redirect the client to the following server:</span>
    <span class="c1">-- I send an error with the redirection server address in its description</span>
    <span class="n">INFO</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">Subscription of client &quot;</span><span class="p">,</span> <span class="n">client</span><span class="p">.</span><span class="n">address</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s"> (_subscribers=&quot;</span><span class="p">,</span> <span class="n">_subscribers</span><span class="p">,</span> <span class="s2">&quot;</span><span class="s">)&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">_nextServer</span> <span class="ow">and</span> <span class="n">_subscribers</span><span class="o">&gt;=</span><span class="mi">400</span> <span class="k">then</span> <span class="nb">error</span><span class="p">(</span><span class="n">_nextServer</span><span class="p">.</span><span class="n">host</span><span class="p">)</span> <span class="k">end</span>
    <span class="n">_subscribers</span> <span class="o">=</span> <span class="n">_subscribers</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onUnsubscribe</span><span class="p">(</span><span class="n">listener</span><span class="p">)</span>
    <span class="n">_subscribers</span> <span class="o">=</span> <span class="n">_subscribers</span> <span class="o">-</span> <span class="mi">1</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">isTarget</span> <span class="k">then</span>
    <span class="c1">-- incoming server is a following server!</span>
    <span class="k">if</span> <span class="n">_nextServer</span> <span class="k">then</span> <span class="nb">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">following server already connected&quot;</span><span class="p">)</span> <span class="k">end</span>
    <span class="n">_nextServer</span> <span class="o">=</span> <span class="n">server</span>
    <span class="c1">-- informs the following server about my publications</span>
    <span class="k">for</span> <span class="n">id</span><span class="p">,</span><span class="n">publication</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">mona</span><span class="p">.</span><span class="n">publications</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">_nextServer</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">publish&quot;</span><span class="p">,</span><span class="n">publication</span><span class="p">.</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">else</span>
    <span class="c1">-- incoming server is a previous server, we have to create RPC function to receive</span>
    <span class="c1">-- its publication informations</span>
    <span class="n">server</span><span class="p">.</span><span class="n">publications</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">publish</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="c1">-- publication creation</span>
      <span class="n">self</span><span class="p">.</span><span class="n">publications</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">mona</span><span class="p">:</span><span class="n">publish</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">unpublish</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
      <span class="c1">-- publication suppression</span>
      <span class="kd">local</span> <span class="n">publication</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">publications</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">publication</span> <span class="k">then</span> <span class="n">publication</span><span class="p">:</span><span class="n">close</span><span class="p">()</span> <span class="k">end</span>
      <span class="n">self</span><span class="p">.</span><span class="n">publications</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">video</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="kd">local</span> <span class="n">publication</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">publications</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="c1">-- give the video packet to our publication copy</span>
      <span class="k">if</span> <span class="n">publication</span> <span class="k">then</span> <span class="n">publication</span><span class="p">:</span><span class="n">pushVideo</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">audio</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="kd">local</span> <span class="n">publication</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">publications</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="c1">-- give the audio packet to our publication copy</span>
      <span class="k">if</span> <span class="n">publication</span> <span class="k">then</span> <span class="n">publication</span><span class="p">:</span><span class="n">pushAudio</span><span class="p">(</span><span class="n">time</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span> <span class="k">end</span>
    <span class="k">end</span>
    <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">data</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">dataname</span><span class="p">,</span> <span class="n">packet</span><span class="p">)</span>
      <span class="kd">local</span> <span class="n">publication</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">publications</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
      <span class="c1">-- give the data packet to our publication copy</span>
      <span class="k">if</span> <span class="n">publication</span> <span class="k">then</span> <span class="n">publication</span><span class="p">:</span><span class="n">pushData</span><span class="p">(</span><span class="n">packet</span><span class="p">)</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onServerDisconnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="k">if</span> <span class="n">server</span><span class="p">.</span><span class="n">isTarget</span> <span class="k">then</span>
    <span class="c1">-- disconnected server was a following server!</span>
    <span class="n">_nextServer</span> <span class="o">=</span> <span class="kc">nil</span>
    <span class="k">return</span>
  <span class="k">end</span>
  <span class="c1">-- disconnected server was a previous server, close its publications</span>
  <span class="k">for</span> <span class="n">id</span><span class="p">,</span><span class="n">publication</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">publications</span><span class="p">)</span> <span class="k">do</span>
    <span class="n">publication</span><span class="p">:</span><span class="n">close</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
<p>The line <em>if _nextServer and _subscribers&gt;=400 then error(_nextServer.host) end</em> requires a specific client code to work, to redirect as wanted the new subscriber to the new server :</p>
<div class="highlight-as3 notranslate"><div class="highlight"><pre><span class="kd">function </span><span class="nf">onStatusEvent</span><span class="o">(</span><span class="n">event</span><span class="o">:</span><span class="kt">NetStatusEvent</span><span class="o">):</span><span class="kt">void</span> <span class="o">{</span>
  <span class="k">switch</span><span class="o">(</span><span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">code</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">case</span> <span class="s2">&quot;NetStream.Play.Failed&quot;</span><span class="o">:</span>
      <span class="kd">var</span> <span class="n">error</span><span class="p">:</span><span class="kt">Array</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="na">info</span><span class="o">.</span><span class="na">description</span><span class="o">.</span><span class="na">split</span><span class="o">(</span><span class="s2">&quot; &quot;</span><span class="o">);</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">error</span><span class="o">.</span><span class="na">length</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">var</span> <span class="n">host</span><span class="p">:</span><span class="kt">String</span> <span class="o">=</span> <span class="s2">&quot;rtmfp://&quot;</span> <span class="o">+</span> <span class="n">error</span><span class="o">[</span><span class="n">error</span><span class="o">.</span><span class="na">length</span><span class="o">-</span><span class="mi">1</span><span class="o">];</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="n">_netConnection</span><span class="o">.</span><span class="na">connect</span><span class="o">(</span><span class="n">host</span><span class="o">);</span>
      <span class="o">}</span>
      <span class="k">break</span><span class="o">;</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></div>
</div>
</div>
<div class="section" id="load-balancing-and-rendezvous-service">
<h2><a class="toc-backref" href="#id4">Load balancing and rendezvous service</a><a class="headerlink" href="#load-balancing-and-rendezvous-service" title="Permalink to this headline">¶</a></h2>
<p>In a load-balancing solution, usually we opt for hardware solution with a DNS which returns an address ip rotated on a list of addresses. You can realize it in a software way using the <a class="reference internal" href="api.html#ref-onhandshake"><span class="std std-ref">onHandshake(address,path,properties,attempts)</span></a> event:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="c1">-- index incremented to redirect client equally to each server</span>
<span class="n">index</span><span class="o">=</span><span class="mi">0</span>
<span class="k">function</span> <span class="nf">onHandshake</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">properties</span><span class="p">,</span><span class="n">attempts</span><span class="p">)</span>
  <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span>
  <span class="k">if</span> <span class="n">index</span> <span class="o">&gt;</span> <span class="n">mona</span><span class="p">.</span><span class="n">servers</span><span class="p">.</span><span class="n">count</span> <span class="k">then</span> <span class="n">index</span><span class="o">=</span><span class="mi">1</span> <span class="k">end</span> <span class="c1">-- not exceed the number of server available</span>
  <span class="k">return</span> <span class="n">mona</span><span class="p">.</span><span class="n">servers</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="c1">-- load-balacing system!</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Here the server doesn’t accept any connection client, it redirects the client in handshake performing. There is no real benefits comparing with a hardware solution.
An other possibility is to return many server addresses to benefit of parallel connection behavior of RTMFP protocol.</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onHandshake</span><span class="p">(</span><span class="n">address</span><span class="p">,</span><span class="n">path</span><span class="p">,</span><span class="n">properties</span><span class="p">,</span><span class="n">attempts</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">mona</span><span class="p">.</span><span class="n">servers</span>
<span class="k">end</span>
</pre></div>
</div>
<p>Indeed, the client will receive multiple server addresses, and in this case, RTMFP starts multiple connection attempt in parallel, and keep only the faster to answer. It’s an other way of load-balacing system: the more faster wins.</p>
<p>About the P2P rendezvous service of Mona, in a multiple servers way, if the peerA connected to MonaServerA requests a connection to the peerB connected to MonaServerB, of course MonaServerA will be unable to return information about peerB. We have to use the <a class="reference internal" href="api.html#ref-onrendezvousunknown"><span class="std std-ref">onRendezVousUnknown(protocol, peerId)</span></a> event:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onRendezVousUnknown</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">peerId</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">mona</span><span class="p">.</span><span class="n">servers</span> <span class="c1">-- redirect to all the connected servers</span>
<span class="k">end</span>
</pre></div>
</div>
<p>With the above code addition, you can redirect a rendezvous request which fails to other servers.</p>
<p>But it’s always missing a solution to synchronize member of groups in <a class="reference external" href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/net/NetGroup.html">NetGroup</a> usage case. Indeed, a groupA can exists on serverA and contains peerA, and the same groupA can exists on serverB too and contains peerB. peerB and peerA will never meet them. To solve it, you have to use <em>groups:join</em> method (see <a class="reference internal" href="api.html#ref-groups"><span class="std std-ref">Groups</span></a> object description for a complete description of this method).
The idea is simple: you have to share every group inclusion informations between all servers. The following server application code realizes this sharing job:</p>
<div class="highlight-lua notranslate"><div class="highlight"><pre><span class="k">function</span> <span class="nf">onRendezVousUnknown</span><span class="p">(</span><span class="n">protocol</span><span class="p">,</span> <span class="n">peerId</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">mona</span><span class="p">.</span><span class="n">servers</span> <span class="c1">-- redirect to all the connected servers</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onConnection</span><span class="p">(</span><span class="n">client</span><span class="p">)</span>
  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onJoinGroup</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="c1">-- inform other servers of this joining operation</span>
    <span class="n">mona</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span><span class="n">broadcast</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">join&quot;</span><span class="p">,</span><span class="n">group</span><span class="p">.</span><span class="n">rawId</span><span class="p">,</span><span class="n">client</span><span class="p">.</span><span class="n">rawId</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">function</span> <span class="nf">client</span><span class="p">:</span><span class="n">onUnjoinGroup</span><span class="p">(</span><span class="n">group</span><span class="p">)</span>
    <span class="c1">-- inform other servers of this unjoining operation</span>
    <span class="n">mona</span><span class="p">.</span><span class="n">servers</span><span class="p">:</span><span class="n">broadcast</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">unjoin&quot;</span><span class="p">,</span><span class="n">group</span><span class="p">.</span><span class="n">rawId</span><span class="p">,</span><span class="n">client</span><span class="p">.</span><span class="n">rawId</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onServerConnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="c1">-- inform this new incoming server of my group/client relations existing</span>
  <span class="k">for</span> <span class="n">id</span><span class="p">,</span><span class="n">group</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">mona</span><span class="p">.</span><span class="n">groups</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">client</span> <span class="k">in</span> <span class="nb">ipairs</span><span class="p">(</span><span class="n">mona</span><span class="p">.</span><span class="n">groups</span><span class="p">)</span> <span class="k">do</span>
      <span class="n">server</span><span class="p">:</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;</span><span class="s">join&quot;</span><span class="p">,</span><span class="n">group</span><span class="p">.</span><span class="n">rawId</span><span class="p">,</span><span class="n">client</span><span class="p">.</span><span class="n">rawId</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>

  <span class="n">server</span><span class="p">.</span><span class="n">groups</span> <span class="o">=</span> <span class="p">{}</span>
  <span class="c1">-- RPC server functions to receive joining/unjoining operation</span>
  <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">join</span><span class="p">(</span><span class="n">groupId</span><span class="p">,</span><span class="n">clientId</span><span class="p">)</span>
    <span class="c1">-- creation of a virtual member for this group</span>
    <span class="kd">local</span> <span class="n">member</span> <span class="o">=</span> <span class="n">mona</span><span class="p">:</span><span class="n">joinGroup</span><span class="p">(</span><span class="n">clientId</span><span class="p">,</span><span class="n">groupId</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">member</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span> <span class="c1">-- join operation has failed</span>
    <span class="c1">-- We have to attach this member object to its server</span>
    <span class="c1">-- to avoid its destruction by the LUA garbage collector</span>
    <span class="kd">local</span> <span class="n">group</span> <span class="o">=</span> <span class="n">self</span><span class="p">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span> <span class="k">then</span> <span class="n">group</span> <span class="o">=</span> <span class="p">{</span><span class="n">size</span><span class="o">=</span><span class="mi">0</span><span class="p">};</span> <span class="n">self</span><span class="p">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span> <span class="o">=</span> <span class="n">group</span> <span class="k">end</span>
    <span class="n">group</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">group</span><span class="p">.</span><span class="n">size</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">group</span><span class="p">[</span><span class="n">clientId</span><span class="p">]</span> <span class="o">=</span> <span class="n">member</span>
  <span class="k">end</span>
  <span class="k">function</span> <span class="nf">server</span><span class="p">:</span><span class="n">unjoin</span><span class="p">(</span><span class="n">groupId</span><span class="p">,</span><span class="n">clientId</span><span class="p">)</span>
    <span class="c1">-- suppression of a possible virtual member of group</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">group</span> <span class="k">then</span> <span class="k">return</span> <span class="k">end</span>
    <span class="kd">local</span> <span class="n">member</span> <span class="o">=</span> <span class="n">group</span><span class="p">[</span><span class="n">clientId</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">member</span> <span class="k">then</span>
      <span class="n">member</span><span class="p">:</span><span class="n">release</span><span class="p">()</span> <span class="c1">-- detach of its group</span>
      <span class="n">group</span><span class="p">[</span><span class="n">clientId</span><span class="p">]</span> <span class="o">=</span> <span class="kc">nil</span>
      <span class="n">group</span><span class="p">.</span><span class="n">size</span> <span class="o">=</span> <span class="n">group</span><span class="p">.</span><span class="n">size</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">end</span>
    <span class="c1">-- erase the group object if it&#39;s empty now</span>
    <span class="k">if</span> <span class="n">group</span><span class="p">.</span><span class="n">size</span><span class="o">==</span><span class="mi">0</span> <span class="k">then</span> <span class="n">self</span><span class="p">.</span><span class="n">groups</span><span class="p">[</span><span class="n">groupId</span><span class="p">]</span><span class="o">=</span><span class="kc">nil</span> <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">function</span> <span class="nf">onServerDisconnection</span><span class="p">(</span><span class="n">server</span><span class="p">)</span>
  <span class="c1">-- suppression of possible virtual members attached to this server</span>
  <span class="k">for</span> <span class="n">id</span><span class="p">,</span><span class="n">group</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">server</span><span class="p">.</span><span class="n">groups</span><span class="p">)</span> <span class="k">do</span>
    <span class="k">for</span> <span class="n">id</span><span class="p">,</span><span class="n">member</span> <span class="k">in</span> <span class="nb">pairs</span><span class="p">(</span><span class="n">group</span><span class="p">)</span> <span class="k">do</span>
      <span class="k">if</span> <span class="n">id</span> <span class="o">~=</span> <span class="s2">&quot;</span><span class="s">size&quot;</span> <span class="k">then</span> <span class="n">member</span><span class="p">:</span><span class="n">release</span><span class="p">()</span> <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
</div>
</div>
</div>


    </div>
    
    <div class="col-md-12">
    
    
        <p></p>
    </div>

  </div>
</div>

    
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="#">Back to top</a>
      
    </p>
    <p>
        &copy; Copyright 2018, Mathieu Poux &amp; Thomas Jammet.<br/>
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.1.<br/>
    </p>
  </div>
</footer>
    </div>

  </body>
</html>